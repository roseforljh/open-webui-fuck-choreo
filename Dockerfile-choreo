# 1. 直接继承官方编译好的镜像 (省去编译前端和安装 PyTorch 的漫长时间)
FROM ghcr.io/open-webui/open-webui:main

# 2. 设置非 Root 用户 ID (符合 Choreo 要求)
ARG USER_ID=10010
ARG GROUP_ID=10010

# 3. 创建用户并修正权限 (核心步骤)
# 我们将 /app/backend/data 的所有权交给新用户
# 并将 /app 目录设置为对 Group 0 (root组) 可写，以兼容 OpenShift/Choreo 的随机用户策略
RUN groupadd -g $GROUP_ID choreo && \
    useradd -u $USER_ID -g $GROUP_ID -m -d /app/backend/data choreo && \
    chown -R $USER_ID:$GROUP_ID /app/backend/data && \
    # 关键：Choreo 权限硬化 (让 Root Group 可读写)
    chgrp -R 0 /app/backend/data && \
    chmod -R g+rwX /app/backend/data

# 4. 切换到非 Root 用户
USER $USER_ID

# 5. 声明端口
EXPOSE 8080

# 6. 启动命令
CMD [ "bash", "start.sh" ]
